<%= form_with(model: @person, local: true) do |f| %>
  <%= hidden_field_tag :aba, 'contatos' %>
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><i class="bi bi-telephone"></i> <b>Contatos</b></span>
    </div>
    <div class="card-body p-0">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Email</th>
            <th>Telefone</th>
            <th>Celular</th>
            <th>Departamento</th>
            <th>Cargo</th>
            <th>Principal</th>
            <th>Financeiro</th>
            <th>Comercial</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <% @person.contacts.each_with_index do |contact, idx| %>
            <tr>
              <td><input class="form-control form-control-sm" type="text" name="person[contacts_attributes][<%= idx %>][name]" value="<%= contact.name %>" /></td>
              <td><input class="form-control form-control-sm" type="email" name="person[contacts_attributes][<%= idx %>][email]" value="<%= contact.email %>" /></td>
              <td><input class="form-control form-control-sm phone-mask" type="text" name="person[contacts_attributes][<%= idx %>][phone]" value="<%= contact.phone %>" /></td>
              <td><input class="form-control form-control-sm mobile-mask" type="text" name="person[contacts_attributes][<%= idx %>][mobile]" value="<%= contact.mobile %>" /></td>
              <td><input class="form-control form-control-sm" type="text" name="person[contacts_attributes][<%= idx %>][department]" value="<%= contact.department %>" /></td>
              <td><input class="form-control form-control-sm" type="text" name="person[contacts_attributes][<%= idx %>][position]" value="<%= contact.position %>" /></td>
              <td class="text-center"><input type="checkbox" name="person[contacts_attributes][<%= idx %>][primary]" value="1" <%= contact.primary ? 'checked' : '' %> /></td>
              <td class="text-center"><input type="checkbox" name="person[contacts_attributes][<%= idx %>][financial]" value="1" <%= contact.financial ? 'checked' : '' %> /></td>
              <td class="text-center"><input type="checkbox" name="person[contacts_attributes][<%= idx %>][commercial]" value="1" <%= contact.commercial ? 'checked' : '' %> /></td>
              <td><a href="#" class="btn btn-sm btn-outline-danger" data-action="remove-fields">üóëÔ∏è</a></td>
              <input type="hidden" name="person[contacts_attributes][<%= idx %>][id]" value="<%= contact.id %>" />
              <input type="hidden" name="person[contacts_attributes][<%= idx %>][_destroy]" value="false" />
            </tr>
          <% end %>
        </tbody>
      </table>
      <div class="mt-2">
        <button type="button" class="btn btn-info btn-sm" data-action="add-fields" data-association="contacts">Adicionar Contato</button>
      </div>
      <template id="contacts_fields_template">
        <tr>
          <td><input class="form-control form-control-sm" type="text" name="person[contacts_attributes][__INDEX__][name]" /></td>
          <td><input class="form-control form-control-sm" type="email" name="person[contacts_attributes][__INDEX__][email]" /></td>
          <td><input class="form-control form-control-sm phone-mask" type="text" name="person[contacts_attributes][__INDEX__][phone]" /></td>
          <td><input class="form-control form-control-sm mobile-mask" type="text" name="person[contacts_attributes][__INDEX__][mobile]" /></td>
          <td><input class="form-control form-control-sm" type="text" name="person[contacts_attributes][__INDEX__][department]" /></td>
          <td><input class="form-control form-control-sm" type="text" name="person[contacts_attributes][__INDEX__][position]" /></td>
          <td class="text-center"><input type="checkbox" name="person[contacts_attributes][__INDEX__][primary]" value="1" /></td>
          <td class="text-center"><input type="checkbox" name="person[contacts_attributes][__INDEX__][financial]" value="1" /></td>
          <td class="text-center"><input type="checkbox" name="person[contacts_attributes][__INDEX__][commercial]" value="1" /></td>
          <td><a href="#" class="btn btn-sm btn-outline-danger" data-action="remove-fields">üóëÔ∏è</a></td>
          <input type="hidden" name="person[contacts_attributes][__INDEX__][_destroy]" value="false" />
        </tr>
      </template>
    </div>
    <div class="card-footer text-end">
      <%= f.submit 'Salvar', class: 'btn btn-primary btn-sm' %>
      <%= link_to 'Voltar', people_path, class: 'btn btn-secondary btn-sm' %>
    </div>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Adicionar contato
    document.getElementById('add-contact-btn').addEventListener('click', function() {
      const template = document.getElementById('contact-template').innerHTML;
      const contactsContainer = document.getElementById('contacts');
      const newIndex = new Date().getTime();
      const newContact = template.replace(/NEW_RECORD/g, newIndex);
      
      contactsContainer.insertAdjacentHTML('beforeend', newContact);
      
      // Reativar as m√°scaras para os novos campos
      const newPhoneFields = document.querySelectorAll('.phone-mask');
      const newMobileFields = document.querySelectorAll('.mobile-mask');
      
      if (typeof IMask !== 'undefined') {
        newPhoneFields.forEach(function(field) {
          IMask(field, {mask: '(00) 0000-0000'});
        });
        
        newMobileFields.forEach(function(field) {
          IMask(field, {mask: '(00) 00000-0000'});
        });
      }
      
      // Adicionar evento aos novos bot√µes de remover
      addRemoveEventListeners();
    });
    
    // Fun√ß√£o para adicionar eventos nos bot√µes de remover
    function addRemoveEventListeners() {
      document.querySelectorAll('.remove-contact-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          const contactField = this.closest('.contact-fields');
          const destroyField = contactField.querySelector('input[name$="[_destroy]"]');
          
          if (destroyField) {
            destroyField.value = "1";
            contactField.style.display = 'none';
          } else {
            contactField.remove();
          }
        });
      });
    }
    
    // Inicializar eventos de remover para contatos existentes
    addRemoveEventListeners();
    
    // Inicializar m√°scaras
    if (typeof IMask !== 'undefined') {
      document.querySelectorAll('.phone-mask').forEach(function(field) {
        IMask(field, {mask: '(00) 0000-0000'});
      });
      
      document.querySelectorAll('.mobile-mask').forEach(function(field) {
        IMask(field, {mask: '(00) 00000-0000'});
      });
    }
  });
</script>